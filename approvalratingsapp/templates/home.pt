<html metal:use-macro="load: mytemplate.pt">
	<div metal:fill-slot="content" class="content">
		<tal:block tal:repeat="ratings_tuple ratings_tuple_list">
			<div class="list-group">
				<a href="#" class="list-group-item active">
					<h4 class="list-group-item-heading" tal:replace="ratings_tuple[0].name">List group item heading</h4>
				</a>
				<!-- If user has not rated this before -->
				<tal:block tal:condition="not ratings_tuple[1]">
					<div class="panel panel-default">
						<div class="panel-body" name="edit_rating_panel">
							<form class="user_rating" id="${ratings_tuple[0].id}">
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="-2"> -2
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="-1"> -1
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="0"> 0
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="1"> +1
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="2"> +2
							</form>
						</div>
						<div class="panel-body hide" name="display_rating_panel">
							Your rating:
							<span>
								<a href="#" onclick="change_rating()" name="user_rating_val"></a>
							</span>
						</div>
					</div>
				</tal:block>

				<!-- If user has rated this before -->
				<tal:block tal:condition="ratings_tuple[1]">
					<div class="panel panel-default">
						<div class="panel-body hide" name="edit_rating_panel">
							<form class="user_rating" id="${ratings_tuple[0].id}">
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="-2"> -2
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="-1"> -1
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="0"> 0
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="1"> +1
								<input type="radio" name="${ratings_tuple[0].id}_rating" value="2"> +2
							</form>
						</div>
						<div class="panel-body">
							Your rating:
							<span tal:attributes="value ratings_tuple[1].rating">
								<a href="#" onclick="change_rating()" name="user_rating_val">${ratings_tuple[1].rating}</a>
							</span>
						</div>
					</div>
				</tal:block>
			</div>
		</tal:block>
		<script type="text/javascript">
			$('.user_rating').change(function() {
				ratee_id = $(this).attr('id');
				inputName = ratee_id+"_rating";
				rating = $('input[name='+inputName+']:checked', '#'+ratee_id).val();
				<!-- alert("Ratee id is: "+ratee_id); -->
				$.ajax({
					type:'POST',
					url:"${request.application_url}/post_rating",
					data: JSON.stringify({'ratee_id':ratee_id, 'rating':rating}),
					contentType: 'application/json; charset=utf-8'
				})
				.done(function(msg) {
					$('div[name=edit_rating_panel]').addClass("hide");
					$('div[name=display_rating_panel]').removeClass("hide");
					$('a[name=user_rating_val]').text(rating);
				});
			});

			function change_rating() {
				<!-- alert("Yo!"); -->
				$('div[name=edit_rating_panel]').toggleClass("hide");
			}
		</script>
	</div>
</html>